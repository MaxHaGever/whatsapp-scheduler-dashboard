<mat-card style="max-width: 900px; margin: 24px auto; padding: 16px;">
  <h2 style="margin-top: 0;">Onboarding</h2>

  <mat-stepper linear #stepper>
    <!-- Step 1: Business -->
    <mat-step [stepControl]="businessForm">
      <ng-template matStepLabel>Business Profile</ng-template>

      <form [formGroup]="businessForm" style="display: grid; gap: 12px; margin-top: 12px;">
        <mat-form-field appearance="outline">
          <mat-label>Business name</mat-label>
          <input matInput formControlName="name" placeholder="e.g., Max Dental Clinic" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Timezone</mat-label>
          <input matInput formControlName="timezone" placeholder="Asia/Jerusalem" />
        </mat-form-field>

        <div style="display: flex; justify-content: flex-end; gap: 12px;">
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="saveBusinessAndNext(stepper)"
            [disabled]="savingBusiness || businessForm.invalid"
          >
            {{ savingBusiness ? "Saving..." : "Save & Next" }}
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 2: WhatsApp -->
    <mat-step [stepControl]="whatsappForm">
      <ng-template matStepLabel>WhatsApp</ng-template>

      <div style="margin-top: 12px;">
        <form [formGroup]="whatsappForm" style="display: grid; gap: 12px; margin-top: 12px;">
          <mat-form-field appearance="outline">
            <mat-label>WABA ID</mat-label>
            <input matInput formControlName="wabaId" placeholder="e.g., 1234567890" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Phone Number ID</mat-label>
            <input matInput formControlName="phoneNumberId" placeholder="e.g., 9876543210" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Access Token (Permanent recommended)</mat-label>
            <input matInput formControlName="accessToken" placeholder="EAAG..." />
          </mat-form-field>

          <div style="display: flex; justify-content: space-between; gap: 12px; align-items: center;">
            <button mat-button type="button" matStepperPrevious [disabled]="savingWhatsapp">
              Back
            </button>

            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="saveWhatsappAndNext(stepper)"
              [disabled]="savingWhatsapp || whatsappForm.invalid"
            >
              {{ savingWhatsapp ? "Saving..." : "Save & Next" }}
            </button>
          </div>
        </form>

        <mat-card style="margin-top: 16px; padding: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px;">Manual client flow (production)</div>
          <ol style="margin: 0; padding-left: 18px; opacity: 0.9;">
            <li>Meta Business Manager → Business Settings → verify business (recommended)</li>
            <li>Meta Developers → create App → add WhatsApp product</li>
            <li>WhatsApp → API Setup → copy WABA ID + Phone Number ID</li>
            <li>Create a permanent token (system user token is best)</li>
            <li>Paste the IDs + token here and Save</li>
          </ol>
        </mat-card>
      </div>
    </mat-step>

    <!-- Step 3: Google -->
    <mat-step>
      <ng-template matStepLabel>Google Calendar</ng-template>

      <div style="margin-top: 12px;">
        <p style="margin: 0 0 8px 0;">
          Status:
          <strong>
            {{ calendarStatus?.connected ? "Connected ✅" : "Not connected ❌" }}
          </strong>
        </p>

        <div style="display: grid; gap: 10px; margin-top: 16px;">
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="connectGoogle()"
            [disabled]="loadingCalendar"
          >
            Connect Google (opens new tab)
          </button>

          <button
            mat-stroked-button
            type="button"
            (click)="refreshCalendarStatus(); (calendarStatus?.connected ? stepper.next() : null)"
            [disabled]="loadingCalendar"
          >
            I finished connecting → Refresh status
          </button>

          <div style="display: flex; justify-content: space-between; gap: 12px; align-items: center;">
            <button mat-button type="button" matStepperPrevious [disabled]="loadingCalendar">
              Back
            </button>

            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="stepper.next()"
              [disabled]="!calendarStatus?.connected"
            >
              Next
            </button>
          </div>
        </div>

        <p style="margin-top: 12px; opacity: 0.75;">
          After approving Google in the new tab, come back and click “Refresh status”.
        </p>
      </div>
    </mat-step>

    <!-- Step 4: Finish -->
    <mat-step>
      <ng-template matStepLabel>Finish</ng-template>

      <div style="margin-top: 12px;">
        <p>All set.</p>

        <div style="display: flex; justify-content: space-between; gap: 12px;">
          <button mat-button type="button" matStepperPrevious>
            Back
          </button>

          <button mat-raised-button color="primary" type="button" (click)="finish()">
            Go to Dashboard
          </button>
        </div>
      </div>
    </mat-step>
  </mat-stepper>
</mat-card>
